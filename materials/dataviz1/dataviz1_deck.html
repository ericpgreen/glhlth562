<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Data Visualization</title>
    <meta charset="utf-8" />
    <script src="dataviz1_deck_files/header-attrs/header-attrs.js"></script>
    <link href="dataviz1_deck_files/panelset/panelset.css" rel="stylesheet" />
    <script src="dataviz1_deck_files/panelset/panelset.js"></script>
    <script type="application/json" id="xaringanExtra-editable-docid">{"id":"x01e9fb7a985485992b3481f0de62c71","expires":1}</script>
    <script src="dataviz1_deck_files/himalaya/himalaya.js"></script>
    <script src="dataviz1_deck_files/js-cookie/js.cookie.js"></script>
    <link href="dataviz1_deck_files/editable/editable.css" rel="stylesheet" />
    <script src="dataviz1_deck_files/editable/editable.js"></script>
    <link href="dataviz1_deck_files/xaringanExtra-extra-styles/xaringanExtra-extra-styles.css" rel="stylesheet" />
    <script src="dataviz1_deck_files/clipboard/clipboard.min.js"></script>
    <link href="dataviz1_deck_files/xaringanExtra-clipboard/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="dataviz1_deck_files/xaringanExtra-clipboard/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"Copy Code","success":"Copied!","error":"Press Ctrl+C to Copy"})</script>
    <link href="dataviz1_deck_files/shareon/shareon.min.css" rel="stylesheet" />
    <script src="dataviz1_deck_files/shareon/shareon.min.js"></script>
    <link href="dataviz1_deck_files/xaringanExtra-shareagain/shareagain.css" rel="stylesheet" />
    <script src="dataviz1_deck_files/xaringanExtra-shareagain/shareagain.js"></script>
    <link href="dataviz1_deck_files/countdown/countdown.css" rel="stylesheet" />
    <script src="dataviz1_deck_files/countdown/countdown.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="custom_deck.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">


class: titleSlide, hide_logo











<style>.shareagain-bar {
--shareagain-foreground: rgb(255, 255, 255);
--shareagain-background: rgba(0, 0, 0, 0.5);
--shareagain-twitter: none;
--shareagain-facebook: none;
--shareagain-linkedin: none;
--shareagain-pinterest: none;
--shareagain-pocket: none;
--shareagain-reddit: none;
}</style>





# Data Visualization

## The grammar of graphics and ggplot2 API

&lt;br&gt;
&lt;center&gt;&lt;img src="logo.png" width="200px"/&gt;&lt;/center&gt;

---
class: left

# Today's Agenda

.pull-left[
**A. Warm-up**
1.  Introductions
2.  Setup

**B. The grammar of graphics and ggplot2 API**
1.	Tidy data
2.  The grammar of graphics
3.	The `{ggplot2}` API 
4.  Questions from the readings
]

.pull-right[
**C. #TidyTuesday**
1.	Dataset review
2.  Expectations/process

**D. How to get help (time permitting)**
]

---

class: bigFocus, hide-count

# Introductions

In ~30 seconds, tell us about your experience with R and interest in data science. If you use R (or have used it in the past), what is your biggest data processing, visualization, or data communication challenge?

<div class="countdown" id="timer_61ddc115" style="right:0;bottom:0;font-size:1em;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---
class: left, hide_logo, hide-count

## Setup

.pull-left[
**Option 1**
* Create a folder called `glhlth562` on Box or Dropbox (not for sharing, just for backup)
* Create a subfolder called `glhlth562/materials`
* Create another subfolder called `glhlth562/prep`
* Move your class prep into `glhlth562/prep`
* Download and unzip today's materials into `glhlth562/materials`
]

.pull-right[
**Option 2**
* Clone the repository from https://github.com/ericpgreen/glhlth562
* Create a subfolder called `glhlth562/prep`
* Move your class prep into `glhlth562/prep`
]

---
class: newTopic, hide_logo

# The grammar of graphics and ggplot2 API

---

class: newTopicSub, hide_logo

# Data science life cycle

---

&lt;img src="img/data-science-cycle/data-science-cycle.004.png" width="90%" style="display: block; margin: auto auto auto 0;" /&gt;

---

&lt;img src="img/data-science-cycle/data-science-cycle.007.png" width="90%" style="display: block; margin: auto auto auto 0;" /&gt;

---
class: left, hide_logo, hide-count

### No one does this better than the FT's COVID team

&lt;iframe src="https://www.ft.com/content/a2901ce8-5eb7-4633-b89c-cbdf5b386938" width="100%" height="90%" data-external="1"&gt;&lt;/iframe&gt;

---
class: left, hide_logo, hide-count

### John Burn-Murdoch on why he uses {ggplot2}

&lt;iframe src="https://johnburnmurdoch.github.io/slides/r-ggplot/#/" width="100%" height="90%" data-external="1"&gt;&lt;/iframe&gt;

---

class: newTopicSub, hide_logo

# Tidy data and data wrangling

&lt;img src="img/data-science-cycle/data-science-cycle.003.png" width="60%" style="display: block; margin: auto;" /&gt;

---

class: left, hide-count

### What is your guess at how the data are structured?

&lt;img src="img/ft2.png" width="80%" style="display: block; margin: auto;" /&gt;

<div class="countdown" id="timer_61ddc3e4" style="right:0;bottom:0;font-size:1em;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">01</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>
---

class: left

### Wide format by state/county 

&lt;img src="img/data.png" width="100%" /&gt;

---
class: left

### Tidy data

According to Hadley Wickham, RStudio's Chief Scientist and creator of many great packages like `{ggplot2}`, [tidy data](https://www.jstatsoft.org/article/view/v059i10) have three characteristics:

1. Each variable forms a column.
2. Each observation forms a row.
3. Each type of observational unit forms a table.

---
class: left

.pull-left[
### Long format
&lt;img src="img/long.png" width="100%" style="display: block; margin: auto;" /&gt;
]

.pull-right[
### State-level data separate
&lt;img src="img/pop.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---

class: left

### There is (usually) no free lunch

.pull-left[
Data are rarely ready to plot right out of the box. We'll skip the import and wrangling details for now, but take note (right) of what's required in this case.
]

.verysmall[
.pull-right[
```
pop &lt;- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv") %&gt;%
  # keep only the columns we need
    select(Province_State, Population) %&gt;%
  # keep only the rows we need
    filter(Province_State=="North Carolina" | Province_State=="Arizona") %&gt;%
  # aggregate population
    group_by(Province_State) %&gt;%
    summarize(Population = sum(Population)) 

covid &lt;- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv") %&gt;%
  # keep only the columns we need
    select(Province_State, Population, contains("/")) %&gt;%
  # keep only the rows we need
    filter(Province_State=="North Carolina" | Province_State=="Arizona") %&gt;%
  # make long
    pivot_longer(cols = c(-Province_State, -Population),
                 names_to = "date",
                 values_to = "totalDeaths") %&gt;%
  # convert date to proper date
    mutate(date = mdy(date)) %&gt;%
  # aggregate by state and date
    group_by(Province_State, date) %&gt;%
    summarize(totalDeaths = sum(totalDeaths)) %&gt;%
  # calculate daily deaths
  # end up with some negative values, likely due to data revisions
    group_by(Province_State) %&gt;%
    mutate(dailyDeaths = c(totalDeaths[1], diff(totalDeaths))) %&gt;%
  # make sure series is complete
    ungroup() %&gt;%
    complete(Province_State, date, fill = list(0)) %&gt;%
  # keep only dates in range
    filter(date &gt;= "2020-08-20" &amp; date &lt;= "2021-07-12") %&gt;%
  # calculate rolling mean
    group_by(Province_State) %&gt;%
    mutate(deaths_roll7 = zoo::rollmean(dailyDeaths, k = 7, fill = NA)) %&gt;%
    filter(!is.na(deaths_roll7)) %&gt;%
    filter(date &gt;= "2020-09-01") %&gt;%
  # merge in pop data and normalize
    left_join(pop, by="Province_State") %&gt;%
    mutate(deaths_roll7_100k = (deaths_roll7/Population)*100000) %&gt;%
  # label the last entry for each state (for the plotting step)
    mutate(label = if_else(date == max(date), 
                           Province_State, 
                           NA_character_)) %&gt;%
    select(Province_State, date, deaths_roll7_100k, label)
``` 
] 
]

---

class: newTopicSub, hide_logo

# Grammar of graphics

---

class: left, hide-count

### What are the key plot elements?

&lt;img src="img/ft2.png" width="75%" style="display: block; margin: auto;" /&gt;

<div class="countdown" id="timer_61ddc16a" style="right:0;bottom:0;font-size:1em;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">01</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---

class: left

### What are the key plot elements?

.pull-left[
&lt;img src="img/ft2.png" width="100%" style="display: block; margin: auto;" /&gt;
]

.pull-right[
  .can-edit[Your ideas]
]

---

class: left

### What are the key plot elements?

.pull-left[
&lt;img src="img/ft2.png" width="100%" style="display: block; margin: auto;" /&gt;
]

.pull-right[
* Lines by group with group labels
* Axis labels
* Headline title
* Down to business subtitle
* Logo
* Caption with data source
* FT theme
* Tool tip
]

---
class: left

# Grammar of graphics

&lt;div style= "float:left;position: relative; top: -20px;left: -40px;"&gt;
&lt;img src="img/wilkinson.jpg" style="border: 0;"&gt;
&lt;/div&gt;

`{ggplot2}` implements the Leland Wilkinson's "grammar of graphics". Wickham (2010) describes the grammar of graphics as: 

"...a tool that enables us to concisely describe the components of a graphic. Such a grammar allows us to move beyond named graphics (e.g., the "scatterplot") and gain insight into the deep structure that underlies statistical graphics."

---
class: left

&lt;img src="img/thomas_ggplot.png" width="90%" style="display: block; margin: auto;" /&gt;

&lt;span style="font-size: 50%;"&gt;Source: Thomas Lin Pederson. Amazing workshop on `ggplot2`: https://github.com/thomasp85/ggplot2_workshop&lt;/span&gt;

---
class: left

&lt;img src="img/ggplot_gif.gif" width="90%" style="display: block; margin: auto;" /&gt;

&lt;span style="font-size: 50%;"&gt;Source: Thomas de Beus, https://tinyurl.com/sf8zude&lt;/span&gt;

---
class: newTopicSub, hide_logo

# {ggplot2} API

---

class: left

### Let's use this example to explore the API

&lt;img src="img/ft2.png" width="70%" style="display: block; margin: auto;" /&gt;


---

class: left

### Open RStudio

.pull-left[
* Find and open the `dataviz1_template.Rmd` file in `materials/dataviz1`. 
* Install packages in `setup` chunk
* Scroll to `canvas` chunk
* Press the arrow pointing down

(We'll dig into the details of RMarkdown files like this later)
]

.pull-right[
&lt;img src="img/open.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---
class: left

### `glimpse()` the processed data

The data are stored in an object called `covid`. In addition to running `glimpse(covid)`, you can also click on `covid` in the Environment to see a 'spreadsheet' view.


```
## Rows: 624
## Columns: 6
## $ X1                &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 1…
## $ Province_State    &lt;chr&gt; "Arizona", "Arizona", "Arizona", "Arizona", "Arizona…
## $ date              &lt;date&gt; 2020-09-01, 2020-09-02, 2020-09-03, 2020-09-04, 202…
## $ deaths_roll7      &lt;dbl&gt; 27.57143, 28.57143, 27.28571, 27.14286, 25.28571, 26…
## $ deaths_roll7_100k &lt;dbl&gt; 0.3787952, 0.3925339, 0.3748698, 0.3729072, 0.347392…
## $ label             &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
```

---

class: left

### The `ggplot()` function

.panelset[
.panel[.panel-name[Code]

`ggplot()` tells R that we want to plot something, but we haven't specified any data or told R how the data map to this plot canvas.


```r
# see chunk 'canvas'
ggplot()
```
]

.panel[.panel-name[Plot]

&lt;img src="dataviz1_deck_files/figure-html/canvas_plot-1.png" width="100%" /&gt;
]

]

---

class: left

### Map data to the canvas

.panelset[
.panel[.panel-name[Code]

The first step is to tell `ggplot()` what data you want to plot and specify how the data maps onto the canvas. Which variable maps to the `x` axis? To the `y` axis?


```r
# see chunk 'mapping'
ggplot(covid, aes(x = ____, y = ____))
```
]

.panel[.panel-name[Answer]


```r
ggplot(covid, aes(x = date, y = deaths_roll7_100k))
```
]

.panel[.panel-name[Plot]

&lt;img src="dataviz1_deck_files/figure-html/mapping_plot-1.png" width="100%" /&gt;
]


]

---

class: left, hide_logo

### Add a `geom_`

&lt;iframe src="https://ggplot2.tidyverse.org/reference/#section-layers" width="100%" height="90%" data-external="1"&gt;&lt;/iframe&gt;


---

class: left

### Add a `geom_`

.panelset[
.panel[.panel-name[Code]

Our plot has appropriate axes now that we've mapped the data, but the canvas is blank because we've not told R how to represent the data. Our inspiration plot uses lines, so we will too.


```r
# see chunk 'geom'
ggplot(covid, aes(x = date, y = deaths_roll7_100k)) +
  geom_line()
```
]

.panel[.panel-name[Plot]

&lt;img src="dataviz1_deck_files/figure-html/geom_plot-1.png" width="100%" /&gt;
]

]
---

class: left

### Specify the grouping

.panelset[
.panel[.panel-name[Code]

This does not look right because we did not tell R that the data are grouped. `covid` is a 'long' dataset with two series: Arizona and North Carolina. Which variable contains this grouping information?


```r
# see chunk 'grouping'
ggplot(covid, aes(x = date, y = deaths_roll7_100k,
                  group = ____)) +
  geom_line()
```
]

.panel[.panel-name[Answer]


```r
ggplot(covid, aes(x = date, y = deaths_roll7_100k,
                  group = Province_State)) +
  geom_line()
```
]

.panel[.panel-name[Plot]

&lt;img src="dataviz1_deck_files/figure-html/grouping_plot-1.png" width="100%" /&gt;
]

]

---
class: left

### Specify the grouping color

.panelset[
.panel[.panel-name[Code]

We need to add color to identify each state's line. One point of friction for new users is deciding whether to use `color` or `fill`. Remember this: Lines and points use `color`. 


```r
# see chunk 'addColor'
ggplot(covid, aes(x = date, y = deaths_roll7_100k,
                  color = Province_State)) +
  geom_line()
```

Rather than specifying `group` explicitly, we can simplify to `color`, which implicitly tells R that we're coloring by group.

]

.panel[.panel-name[Plot]

&lt;img src="dataviz1_deck_files/figure-html/addColor_plot-1.png" width="100%" /&gt;
]

]

---

class: left

### Modify the style

We'll dig into plot refinements later. For now, just take note of the layering approach.

.panelset[
.panel[.panel-name[Code]


```r
# see chunk 'changeColors'
ggplot(covid,                                     # data
       aes(x = date, y = deaths_roll7_100k,       # mapping
           color = Province_State)) +
       geom_line() +                              # geom
       scale_color_manual(values = c(             # theme
                                     "#eb5e8d",     # pink 
                                     "#0f5599"      # blue
                                     )) +
      ft_theme()                                  
```

]

.panel[.panel-name[Plot]

&lt;img src="dataviz1_deck_files/figure-html/changeColors_plot-1.png" width="70%" /&gt;
]
]
---

class: left

&lt;img src="img/thomas_ggplot.png" width="90%" style="display: block; margin: auto;" /&gt;

&lt;span style="font-size: 50%;"&gt;Source: Thomas Lin Pederson. Amazing workshop on `ggplot2`: https://github.com/thomasp85/ggplot2_workshop&lt;/span&gt;

---

class: left

# Credits

Deck by Eric Green ([@ericpgreen](https://twitter.com/ericpgreen)), licensed under Creative Commons Attribution [CC BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/)

* {[`xaringan`](https://github.com/yihui/xaringan)} for slides with help from {[`xaringanExtra`](https://github.com/gadenbuie/xaringanExtra)} 
* Data science lifecycle, [Data Science in a Box](https://datasciencebox.org/)
* [JHU CSSE COVID-19 data](https://github.com/CSSEGISandData/COVID-19)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"slideNumberFormat": "%current%",
"highlightStyle": "github",
"highlightLines": true,
"ratio": "16:9",
"countIncrementalSlides": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
